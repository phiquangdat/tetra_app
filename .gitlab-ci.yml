stages:
  - build
  - test
  - deploy

variables:
  DOCKER_REGISTRY: $CI_REGISTRY
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:latest
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:latest

before_script:
  - echo "Preparing Docker environment"
  - docker info
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $DOCKER_REGISTRY

build_backend:
  stage: build
  script:
    - echo "Building backend Docker image"
    - docker build -t $BACKEND_IMAGE ./backend
    - docker push $BACKEND_IMAGE

build_frontend:
  stage: build
  script:
    - echo "Building frontend Docker image"
    - docker build -t $FRONTEND_IMAGE ./frontend
    - docker push $FRONTEND_IMAGE

test_backend:
  stage: test
  script:
    - echo "Running backend tests"
    - cd backend
    - ./gradlew test --no-daemon

test_frontend:
  stage: test
  script:
    - echo "Running frontend tests"
    - cd frontend
    - npm install
    - npm test -- --watchAll=false

deploy:
  stage: deploy
  script:
    - echo "Deploying images to production"
    - docker pull $BACKEND_IMAGE
    - docker pull $FRONTEND_IMAGE
